<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataInsight AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
        }
        .upload-zone:hover {
            background: #f0f4ff;
        }
        .upload-zone.dragover {
            background: #e0e7ff;
            border-color: #764ba2;
        }
        .chat-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        #userInput:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .suggestion {
            padding: 10px 15px;
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #667eea;
        }
        .suggestion:hover {
            background: #667eea;
            color: white;
        }
        #response {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 100px;
            margin-bottom: 20px;
        }
        #chartContainer {
            position: relative;
            height: 400px;
            display: none;
        }
        #dataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: none;
        }
        #dataTable th, #dataTable td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
        }
        #dataTable th {
            background: #667eea;
            color: white;
        }
        #dataTable tr:nth-child(even) {
            background: #f8f9fa;
        }
        .anomaly {
            background: #ffe0e0 !important;
            color: #c00;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        .file-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        .hidden { display: none; }
        .lang-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: 0.3s;
        }
        .lang-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .lang-btn .flag {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <button class="lang-btn" onclick="toggleLanguage()">
        <span class="flag">üá¨üáß</span><span id="langText">English</span>
    </button>

    <div class="container">
        <h1>DataInsight AI</h1>

        <!-- Upload -->
        <div class="card">
            <h2 data-i18n="uploadTitle">1. Charger vos donnees</h2>
            <div class="upload-zone" id="uploadZone">
                <p style="font-size: 3rem;">üìÅ</p>
                <p data-i18n="uploadText">Glissez votre fichier CSV ici ou cliquez pour selectionner</p>
                <input type="file" id="fileInput" accept=".csv" hidden>
            </div>
            <div class="file-info" id="fileInfo">
                <strong data-i18n="fileLoaded">Fichier charge :</strong> <span id="fileName"></span><br>
                <strong data-i18n="rows">Lignes :</strong> <span id="rowCount"></span> |
                <strong data-i18n="columns">Colonnes :</strong> <span id="colCount"></span>
            </div>
        </div>

        <!-- Chat AI -->
        <div class="card">
            <h2 data-i18n="askAITitle">2. Demandez a l'IA</h2>
            <div class="suggestions">
                <span class="suggestion" data-i18n="btnBarChart" data-query-fr="Montre un graphique en barres" data-query-en="Show a bar chart" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìä Graphique en barres</span>
                <span class="suggestion" data-i18n="btnLineChart" data-query-fr="Montre un graphique en ligne" data-query-en="Show a line chart" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìà Graphique en ligne</span>
                <span class="suggestion" data-i18n="btnPieChart" data-query-fr="Montre un camembert" data-query-en="Show a pie chart" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">ü•ß Camembert</span>
                <span class="suggestion" data-i18n="btnTable" data-query-fr="Affiche le tableau" data-query-en="Show the table" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìã Tableau</span>
                <span class="suggestion" data-i18n="btnAnomalies" data-query-fr="Detecte les anomalies" data-query-en="Detect anomalies" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">‚ö†Ô∏è Anomalies</span>
                <span class="suggestion" data-i18n="btnStats" data-query-fr="Montre les statistiques" data-query-en="Show statistics" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìâ Statistiques</span>
            </div>
            <div class="chat-container">
                <input type="text" id="userInput" data-i18n-placeholder="inputPlaceholder" placeholder="Ex: Montre un graphique des ventes, detecte les anomalies...">
                <button class="btn" onclick="askAI()" data-i18n="sendBtn">Envoyer</button>
            </div>
            <div id="response">
                <p style="color: #888;" data-i18n="initialMessage">Chargez un fichier CSV puis posez votre question...</p>
            </div>
        </div>

        <!-- Results -->
        <div class="card" id="resultsCard" style="display: none;">
            <h2 data-i18n="resultsTitle">3. Resultats</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <div id="chartContainer">
                <canvas id="myChart"></canvas>
            </div>
            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ===== SYST√àME DE TRADUCTION =====
        let currentLang = localStorage.getItem('datainsight-lang') || 'fr';

        const translations = {
            fr: {
                langText: 'English',
                langFlag: 'üá¨üáß',
                uploadTitle: '1. Charger vos donnees',
                uploadText: 'Glissez votre fichier CSV ici ou cliquez pour selectionner',
                fileLoaded: 'Fichier charge :',
                rows: 'Lignes :',
                columns: 'Colonnes :',
                askAITitle: '2. Demandez a l\'IA',
                btnBarChart: 'üìä Graphique en barres',
                btnLineChart: 'üìà Graphique en ligne',
                btnPieChart: 'ü•ß Camembert',
                btnTable: 'üìã Tableau',
                btnAnomalies: '‚ö†Ô∏è Anomalies',
                btnStats: 'üìâ Statistiques',
                inputPlaceholder: 'Ex: Montre un graphique des ventes, detecte les anomalies...',
                sendBtn: 'Envoyer',
                initialMessage: 'Chargez un fichier CSV puis posez votre question...',
                resultsTitle: '3. Resultats',
                fileLoadedSuccess: '‚úÖ Fichier charge ! Vous pouvez maintenant poser vos questions.',
                pleaseSelectCSV: 'Veuillez selectionner un fichier CSV',
                pleaseLoadCSV: '‚ö†Ô∏è Veuillez d\'abord charger un fichier CSV',
                barChartResponse: 'Voici un graphique en barres de vos donnees.',
                lineChartResponse: 'Voici un graphique en ligne de vos donnees.',
                pieChartResponse: 'Voici un graphique en camembert de vos donnees.',
                tableResponse: 'Voici le tableau de vos donnees.',
                graphResponse: 'Voici un graphique de vos donnees. Precisez le type souhaite (barres, ligne, camembert).',
                helpMessage: 'Je peux vous aider avec :<br>- Graphiques (barres, ligne, camembert)<br>- Tableau des donnees<br>- Detection d\'anomalies<br>- Statistiques',
                anomaliesFound: ' anomalie(s) detectee(s)',
                inLines: ' dans ',
                linesText: ' ligne(s).',
                anomalyExplanation: '<br>Les lignes en rouge dans le tableau sont suspectes (valeurs eloignees de la moyenne).',
                noAnomalies: '‚úÖ Aucune anomalie detectee dans vos donnees. Tout semble normal !',
                statsResponse: 'Voici les statistiques de vos colonnes numeriques (moyenne, min, max).'
            },
            en: {
                langText: 'Fran√ßais',
                langFlag: 'üá´üá∑',
                uploadTitle: '1. Load your data',
                uploadText: 'Drag your CSV file here or click to select',
                fileLoaded: 'File loaded:',
                rows: 'Rows:',
                columns: 'Columns:',
                askAITitle: '2. Ask the AI',
                btnBarChart: 'üìä Bar chart',
                btnLineChart: 'üìà Line chart',
                btnPieChart: 'ü•ß Pie chart',
                btnTable: 'üìã Table',
                btnAnomalies: '‚ö†Ô∏è Anomalies',
                btnStats: 'üìâ Statistics',
                inputPlaceholder: 'Ex: Show a sales chart, detect anomalies...',
                sendBtn: 'Send',
                initialMessage: 'Load a CSV file then ask your question...',
                resultsTitle: '3. Results',
                fileLoadedSuccess: '‚úÖ File loaded! You can now ask your questions.',
                pleaseSelectCSV: 'Please select a CSV file',
                pleaseLoadCSV: '‚ö†Ô∏è Please load a CSV file first',
                barChartResponse: 'Here is a bar chart of your data.',
                lineChartResponse: 'Here is a line chart of your data.',
                pieChartResponse: 'Here is a pie chart of your data.',
                tableResponse: 'Here is the table of your data.',
                graphResponse: 'Here is a chart of your data. Specify the type you want (bar, line, pie).',
                helpMessage: 'I can help you with:<br>- Charts (bar, line, pie)<br>- Data table<br>- Anomaly detection<br>- Statistics',
                anomaliesFound: ' anomaly(ies) detected',
                inLines: ' in ',
                linesText: ' row(s).',
                anomalyExplanation: '<br>Red rows in the table are suspicious (values far from the average).',
                noAnomalies: '‚úÖ No anomalies detected in your data. Everything looks normal!',
                statsResponse: 'Here are the statistics of your numeric columns (average, min, max).'
            }
        };

        function applyTranslations() {
            const t = translations[currentLang];

            // Mettre √† jour le bouton de langue
            document.getElementById('langText').textContent = t.langText;
            document.querySelector('.lang-btn .flag').textContent = t.langFlag;

            // Traduire tous les √©l√©ments avec data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.innerHTML = t[key];
                }
            });

            // Traduire les placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });

            // Mettre √† jour l'attribut lang du HTML
            document.documentElement.lang = currentLang;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            localStorage.setItem('datainsight-lang', currentLang);
            applyTranslations();
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        // Appliquer les traductions au chargement
        document.addEventListener('DOMContentLoaded', applyTranslations);

        // ===== APPLICATION PRINCIPALE =====
        let csvData = [];
        let headers = [];
        let numericCols = [];
        let myChart = null;

        // Upload zone events
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        // Enter key
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askAI();
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert(t('pleaseSelectCSV'));
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                parseCSV(e.target.result);
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('rowCount').textContent = csvData.length;
                document.getElementById('colCount').textContent = headers.length;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('response').innerHTML = '<p style="color: green;">' + t('fileLoadedSuccess') + '</p>';
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            headers = lines[0].split(/[,;]/).map(h => h.trim().replace(/"/g, ''));
            csvData = [];
            numericCols = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/[,;]/).map(v => v.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => {
                        const val = values[idx];
                        row[h] = isNaN(parseFloat(val)) ? val : parseFloat(val);
                    });
                    csvData.push(row);
                }
            }

            // Detect numeric columns
            headers.forEach(h => {
                const nums = csvData.filter(r => typeof r[h] === 'number' && !isNaN(r[h]));
                if (nums.length > csvData.length * 0.5) {
                    numericCols.push(h);
                }
            });
        }

        function askAI(preset) {
            const input = preset || document.getElementById('userInput').value;
            if (!input.trim()) return;

            if (csvData.length === 0) {
                document.getElementById('response').innerHTML = '<p style="color: red;">' + t('pleaseLoadCSV') + '</p>';
                return;
            }

            const query = input.toLowerCase();
            document.getElementById('resultsCard').style.display = 'block';

            // Detect intent (FR + EN keywords)
            if (query.includes('barre') || query.includes('bar')) {
                createChart('bar');
                respond(t('barChartResponse'));
            }
            else if (query.includes('ligne') || query.includes('line') || query.includes('courbe')) {
                createChart('line');
                respond(t('lineChartResponse'));
            }
            else if (query.includes('camembert') || query.includes('pie') || query.includes('secteur')) {
                createChart('pie');
                respond(t('pieChartResponse'));
            }
            else if (query.includes('tableau') || query.includes('table') || query.includes('liste')) {
                showTable();
                respond(t('tableResponse'));
            }
            else if (query.includes('anomalie') || query.includes('anomaly') || query.includes('outlier') || query.includes('bizarre')) {
                detectAnomalies();
            }
            else if (query.includes('stat') || query.includes('moyenne') || query.includes('average') || query.includes('resume')) {
                showStats();
            }
            else if (query.includes('graphique') || query.includes('graph') || query.includes('chart') || query.includes('visualis')) {
                createChart('bar');
                respond(t('graphResponse'));
            }
            else {
                respond(t('helpMessage'));
            }

            document.getElementById('userInput').value = '';
        }

        function respond(text) {
            document.getElementById('response').innerHTML = '<p>ü§ñ ' + text + '</p>';
        }

        function createChart(type) {
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('statsGrid').innerHTML = '';

            if (myChart) myChart.destroy();

            const col = numericCols[0] || headers[0];
            const labels = csvData.map((r, i) => r[headers[0]] || 'Item ' + (i+1)).slice(0, 20);
            const data = csvData.map(r => r[col]).slice(0, 20);

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140'
            ];

            myChart = new Chart(document.getElementById('myChart'), {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: col,
                        data: data,
                        backgroundColor: type === 'pie' ? colors : '#667eea',
                        borderColor: type === 'line' ? '#667eea' : 'white',
                        borderWidth: 2,
                        fill: type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'pie' }
                    }
                }
            });
        }

        function showTable(anomalyRows = []) {
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            document.getElementById('statsGrid').innerHTML = '';

            let headHTML = '<tr>' + headers.map(h => '<th>' + h + '</th>').join('') + '</tr>';
            document.getElementById('tableHead').innerHTML = headHTML;

            let bodyHTML = '';
            csvData.slice(0, 50).forEach((row, idx) => {
                const isAnomaly = anomalyRows.includes(idx);
                bodyHTML += '<tr class="' + (isAnomaly ? 'anomaly' : '') + '">';
                headers.forEach(h => {
                    bodyHTML += '<td>' + (row[h] !== undefined ? row[h] : '') + '</td>';
                });
                bodyHTML += '</tr>';
            });
            document.getElementById('tableBody').innerHTML = bodyHTML;
        }

        function detectAnomalies() {
            document.getElementById('statsGrid').innerHTML = '';

            let totalAnomalies = 0;
            let anomalyRows = [];
            let details = '';

            numericCols.forEach(col => {
                const values = csvData.map(r => r[col]).filter(v => typeof v === 'number');
                const mean = values.reduce((a,b) => a+b, 0) / values.length;
                const std = Math.sqrt(values.reduce((s,v) => s + Math.pow(v-mean,2), 0) / values.length);

                csvData.forEach((row, idx) => {
                    if (typeof row[col] === 'number') {
                        const zscore = Math.abs((row[col] - mean) / std);
                        if (zscore > 2.5) {
                            totalAnomalies++;
                            if (!anomalyRows.includes(idx)) anomalyRows.push(idx);
                        }
                    }
                });
            });

            if (totalAnomalies > 0) {
                respond('‚ö†Ô∏è <strong>' + totalAnomalies + t('anomaliesFound') + '</strong>' + t('inLines') + anomalyRows.length + t('linesText') + t('anomalyExplanation'));
                showTable(anomalyRows);
            } else {
                respond(t('noAnomalies'));
                showTable();
            }
        }

        function showStats() {
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';

            let html = '';
            numericCols.forEach(col => {
                const values = csvData.map(r => r[col]).filter(v => typeof v === 'number');
                const mean = (values.reduce((a,b) => a+b, 0) / values.length).toFixed(2);
                const min = Math.min(...values).toFixed(2);
                const max = Math.max(...values).toFixed(2);

                html += `
                    <div class="stat-card">
                        <h3>${mean}</h3>
                        <p><strong>${col}</strong></p>
                        <small>Min: ${min} | Max: ${max}</small>
                    </div>
                `;
            });

            document.getElementById('statsGrid').innerHTML = html;
            respond(t('statsResponse'));
        }
    </script>
</body>
</html>
