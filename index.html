<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataInsight AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Variables CSS pour le th√®me clair (par d√©faut) */
        :root {
            /* Couleurs principales */
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;

            /* Couleurs de fond et texte (mode clair) */
            --bg-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-main: #2d3748;
            --text-muted: #a0aec0;
            --border-color: #e2e8f0;
            --shadow: rgba(0,0,0,0.2);
            --upload-hover: #f0f4ff;
            --upload-dragover: #e0e7ff;
            --response-bg: #f8f9fa;
            --table-even: #f8f9fa;
            --anomaly-bg: #ffe0e0;
            --anomaly-text: #c00;
            --file-info-bg: #e8f5e9;
        }

        /* Th√®me sombre */
        [data-theme="dark"] {
            --bg-main: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-card: #2d3748;
            --text-main: #f7fafc;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --shadow: rgba(0,0,0,0.5);
            --upload-hover: #374151;
            --upload-dragover: #4b5563;
            --response-bg: #374151;
            --table-even: #374151;
            --anomaly-bg: #7f1d1d;
            --anomaly-text: #fca5a5;
            --file-info-bg: #065f46;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .card h2 {
            color: var(--text-main);
            margin-bottom: 15px;
        }
        
        .upload-zone {
            border: 3px dashed var(--primary);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
            background: transparent;
        }
        
        .upload-zone p {
            color: var(--text-main);
        }
        
        .upload-zone:hover {
            background: var(--upload-hover);
        }
        
        .upload-zone.dragover {
            background: var(--upload-dragover);
            border-color: var(--secondary);
        }
        
        .chat-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s, border-color 0.3s;
        }
        
        #userInput:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .suggestion {
            padding: 10px 15px;
            background: var(--upload-hover);
            border: 2px solid var(--primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: var(--primary);
            transition: all 0.3s;
        }
        
        .suggestion:hover {
            background: var(--primary);
            color: white;
        }
        
        #response {
            background: var(--response-bg);
            border-radius: 10px;
            padding: 20px;
            min-height: 100px;
            margin-bottom: 20px;
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }
        
        #chartContainer {
            position: relative;
            height: 400px;
            display: none;
        }
        
        #dataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: none;
        }
        
        #dataTable th, #dataTable td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }
        
        #dataTable th {
            background: var(--primary);
            color: white;
        }
        
        #dataTable tr:nth-child(even) {
            background: var(--table-even);
        }
        
        .anomaly {
            background: var(--anomaly-bg) !important;
            color: var(--anomaly-text) !important;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .file-info {
            background: var(--file-info-bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }
        
        .hidden { display: none; }
        
        .lang-btn {
            position: fixed;
            top: 20px;
            right: 80px;
            padding: 10px 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 1000;
            transition: all 0.3s;
            color: var(--text-main);
        }
        
        .lang-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .lang-btn .flag {
            margin-right: 8px;
        }

        /* Bouton de th√®me */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1) rotate(20deg);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Bouton de changement de th√®me -->
    <div class="theme-toggle" id="themeToggle" title="Changer de th√®me">
        <span id="themeIcon">üåô</span>
    </div>

    <button class="lang-btn" onclick="toggleLanguage()">
        <span class="flag">üá¨üáß</span><span id="langText">English</span>
    </button>

    <div class="container">
        <h1>DataInsight AI</h1>

        <!-- Upload -->
        <div class="card">
            <h2 data-i18n="uploadTitle">1. Charger vos donnees</h2>
            <div class="upload-zone" id="uploadZone">
                <p style="font-size: 3rem;">üìÅ</p>
                <p data-i18n="uploadText">Glissez votre fichier CSV ici ou cliquez pour selectionner</p>
                <input type="file" id="fileInput" accept=".csv" hidden>
            </div>
            <div class="file-info" id="fileInfo">
                <strong data-i18n="fileLoaded">Fichier charge :</strong> <span id="fileName"></span><br>
                <strong data-i18n="rows">Lignes :</strong> <span id="rowCount"></span> |
                <strong data-i18n="columns">Colonnes :</strong> <span id="colCount"></span>
            </div>
        </div>

        <!-- Chat AI -->
        <div class="card">
            <h2 data-i18n="askAITitle">2. Demandez a l'IA</h2>
            <div class="suggestions">
                <span class="suggestion" data-i18n="btnBarChart" data-query-fr="Montre un graphique en barres" data-query-en="Show a bar chart" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìä Graphique en barres</span>
                <span class="suggestion" data-i18n="btnLineChart" data-query-fr="Montre un graphique en ligne" data-query-en="Show a line chart" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìà Graphique en ligne</span>
                <span class="suggestion" data-i18n="btnPieChart" data-query-fr="Montre un camembert" data-query-en="Show a pie chart" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">ü•ß Camembert</span>
                <span class="suggestion" data-i18n="btnTable" data-query-fr="Affiche le tableau" data-query-en="Show the table" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìã Tableau</span>
                <span class="suggestion" data-i18n="btnAnomalies" data-query-fr="Detecte les anomalies" data-query-en="Detect anomalies" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">‚ö†Ô∏è Anomalies</span>
                <span class="suggestion" data-i18n="btnStats" data-query-fr="Affiche les statistiques" data-query-en="Show statistics" onclick="askAI(this.dataset['query' + currentLang.charAt(0).toUpperCase() + currentLang.slice(1)])">üìà Statistiques</span>
            </div>

            <div class="chat-container">
                <input type="text" id="userInput" data-i18n="inputPlaceholder" placeholder="Tapez votre question...">
                <button class="btn" onclick="askAI()" data-i18n="btnAsk">Demander</button>
            </div>

            <div id="response"></div>
        </div>

        <!-- Results -->
        <div class="card" id="resultsCard" style="display: none;">
            <h2 data-i18n="resultsTitle">3. Resultats</h2>

            <div id="chartContainer">
                <canvas id="myChart"></canvas>
            </div>

            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>

            <div class="stats-grid" id="statsGrid"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let csvData = [];
        let headers = [];
        let numericCols = [];
        let myChart = null;
        let currentLang = localStorage.getItem('datainsight-lang') || 'fr';

        // Traductions
        const translations = {
            fr: {
                uploadTitle: '1. Charger vos donnees',
                uploadText: 'Glissez votre fichier CSV ici ou cliquez pour selectionner',
                fileLoaded: 'Fichier charge :',
                rows: 'Lignes :',
                columns: 'Colonnes :',
                askAITitle: '2. Demandez a l\'IA',
                btnBarChart: 'üìä Graphique en barres',
                btnLineChart: 'üìà Graphique en ligne',
                btnPieChart: 'ü•ß Camembert',
                btnTable: 'üìã Tableau',
                btnAnomalies: '‚ö†Ô∏è Anomalies',
                btnStats: 'üìà Statistiques',
                inputPlaceholder: 'Tapez votre question...',
                btnAsk: 'Demander',
                resultsTitle: '3. Resultats',
                pleaseSelectCSV: 'Veuillez selectionner un fichier CSV valide.',
                fileLoadedSuccess: '‚úÖ Fichier charge avec succes ! Posez une question a l\'IA.',
                pleaseLoadCSV: 'Veuillez d\'abord charger un fichier CSV.',
                barChartResponse: 'Voici votre graphique en barres !',
                lineChartResponse: 'Voici votre graphique en ligne !',
                pieChartResponse: 'Voici votre graphique camembert !',
                tableResponse: 'Voici votre tableau de donnees.',
                graphResponse: 'Voici votre graphique !',
                helpMessage: 'Je peux vous aider avec : graphiques (barres, ligne, camembert), tableaux, statistiques, et detection d\'anomalies.',
                anomaliesFound: ' anomalies detectees',
                inLines: ' dans ',
                linesText: ' lignes.',
                anomalyExplanation: ' Les lignes surlignees en rouge contiennent des valeurs extremes.',
                noAnomalies: '‚úÖ Aucune anomalie detectee dans vos donnees.',
                statsResponse: 'Voici les statistiques de vos colonnes numeriques.'
            },
            en: {
                uploadTitle: '1. Load your data',
                uploadText: 'Drag your CSV file here or click to select',
                fileLoaded: 'File loaded:',
                rows: 'Rows:',
                columns: 'Columns:',
                askAITitle: '2. Ask the AI',
                btnBarChart: 'üìä Bar chart',
                btnLineChart: 'üìà Line chart',
                btnPieChart: 'ü•ß Pie chart',
                btnTable: 'üìã Table',
                btnAnomalies: '‚ö†Ô∏è Anomalies',
                btnStats: 'üìà Statistics',
                inputPlaceholder: 'Type your question...',
                btnAsk: 'Ask',
                resultsTitle: '3. Results',
                pleaseSelectCSV: 'Please select a valid CSV file.',
                fileLoadedSuccess: '‚úÖ File loaded successfully! Ask a question to the AI.',
                pleaseLoadCSV: 'Please load a CSV file first.',
                barChartResponse: 'Here is your bar chart!',
                lineChartResponse: 'Here is your line chart!',
                pieChartResponse: 'Here is your pie chart!',
                tableResponse: 'Here is your data table.',
                graphResponse: 'Here is your chart!',
                helpMessage: 'I can help you with: charts (bar, line, pie), tables, statistics, and anomaly detection.',
                anomaliesFound: ' anomalies detected',
                inLines: ' in ',
                linesText: ' rows.',
                anomalyExplanation: ' Rows highlighted in red contain extreme values.',
                noAnomalies: '‚úÖ No anomalies detected in your data.',
                statsResponse: 'Here are the statistics of your numeric columns.'
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function applyTranslations() {
            const trans = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (trans[key]) el.textContent = trans[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (trans[key]) el.placeholder = trans[key];
            });
            document.getElementById('langText').textContent = currentLang === 'fr' ? 'English' : 'Fran√ßais';
            document.querySelector('.lang-btn .flag').textContent = currentLang === 'fr' ? 'üá¨üáß' : 'üá´üá∑';
        }

        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            localStorage.setItem('datainsight-lang', currentLang);
            applyTranslations();
        }

        // Gestion du th√®me
        function initTheme() {
            const savedTheme = localStorage.getItem('datainsight-theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (html.getAttribute('data-theme') === 'dark') {
                // Passer en mode clair
                html.removeAttribute('data-theme');
                localStorage.setItem('datainsight-theme', 'light');
                themeIcon.textContent = 'üåô';
            } else {
                // Passer en mode sombre
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('datainsight-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
            }
        });

        // Upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askAI();
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert(t('pleaseSelectCSV'));
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                parseCSV(e.target.result);
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('rowCount').textContent = csvData.length;
                document.getElementById('colCount').textContent = headers.length;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('response').innerHTML = '<p style="color: green;">' + t('fileLoadedSuccess') + '</p>';
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            headers = lines[0].split(/[,;]/).map(h => h.trim().replace(/"/g, ''));
            csvData = [];
            numericCols = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/[,;]/).map(v => v.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => {
                        const val = values[idx];
                        row[h] = isNaN(parseFloat(val)) ? val : parseFloat(val);
                    });
                    csvData.push(row);
                }
            }

            // Detect numeric columns
            headers.forEach(h => {
                const nums = csvData.filter(r => typeof r[h] === 'number' && !isNaN(r[h]));
                if (nums.length > csvData.length * 0.5) {
                    numericCols.push(h);
                }
            });
        }

        function askAI(preset) {
            const input = preset || document.getElementById('userInput').value;
            if (!input.trim()) return;

            if (csvData.length === 0) {
                document.getElementById('response').innerHTML = '<p style="color: red;">' + t('pleaseLoadCSV') + '</p>';
                return;
            }

            const query = input.toLowerCase();
            document.getElementById('resultsCard').style.display = 'block';

            // Detect intent (FR + EN keywords)
            if (query.includes('barre') || query.includes('bar')) {
                createChart('bar');
                respond(t('barChartResponse'));
            }
            else if (query.includes('ligne') || query.includes('line') || query.includes('courbe')) {
                createChart('line');
                respond(t('lineChartResponse'));
            }
            else if (query.includes('camembert') || query.includes('pie') || query.includes('secteur')) {
                createChart('pie');
                respond(t('pieChartResponse'));
            }
            else if (query.includes('tableau') || query.includes('table') || query.includes('liste')) {
                showTable();
                respond(t('tableResponse'));
            }
            else if (query.includes('anomalie') || query.includes('anomaly') || query.includes('outlier') || query.includes('bizarre')) {
                detectAnomalies();
            }
            else if (query.includes('stat') || query.includes('moyenne') || query.includes('average') || query.includes('resume')) {
                showStats();
            }
            else if (query.includes('graphique') || query.includes('graph') || query.includes('chart') || query.includes('visualis')) {
                createChart('bar');
                respond(t('graphResponse'));
            }
            else {
                respond(t('helpMessage'));
            }

            document.getElementById('userInput').value = '';
        }

        function respond(text) {
            document.getElementById('response').innerHTML = '<p>ü§ñ ' + text + '</p>';
        }

        function createChart(type) {
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('statsGrid').innerHTML = '';

            if (myChart) myChart.destroy();

            const col = numericCols[0] || headers[0];
            const labels = csvData.map((r, i) => r[headers[0]] || 'Item ' + (i+1)).slice(0, 20);
            const data = csvData.map(r => r[col]).slice(0, 20);

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140'
            ];

            myChart = new Chart(document.getElementById('myChart'), {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: col,
                        data: data,
                        backgroundColor: type === 'pie' ? colors : '#667eea',
                        borderColor: type === 'line' ? '#667eea' : 'white',
                        borderWidth: 2,
                        fill: type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'pie' }
                    }
                }
            });
        }

        function showTable(anomalyRows = []) {
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            document.getElementById('statsGrid').innerHTML = '';

            let headHTML = '<tr>' + headers.map(h => '<th>' + h + '</th>').join('') + '</tr>';
            document.getElementById('tableHead').innerHTML = headHTML;

            let bodyHTML = '';
            csvData.slice(0, 50).forEach((row, idx) => {
                const isAnomaly = anomalyRows.includes(idx);
                bodyHTML += '<tr class="' + (isAnomaly ? 'anomaly' : '') + '">';
                headers.forEach(h => {
                    bodyHTML += '<td>' + (row[h] !== undefined ? row[h] : '') + '</td>';
                });
                bodyHTML += '</tr>';
            });
            document.getElementById('tableBody').innerHTML = bodyHTML;
        }

        function detectAnomalies() {
            document.getElementById('statsGrid').innerHTML = '';

            let totalAnomalies = 0;
            let anomalyRows = [];
            let details = '';

            numericCols.forEach(col => {
                const values = csvData.map(r => r[col]).filter(v => typeof v === 'number');
                const mean = values.reduce((a,b) => a+b, 0) / values.length;
                const std = Math.sqrt(values.reduce((s,v) => s + Math.pow(v-mean,2), 0) / values.length);

                csvData.forEach((row, idx) => {
                    if (typeof row[col] === 'number') {
                        const zscore = Math.abs((row[col] - mean) / std);
                        if (zscore > 2.5) {
                            totalAnomalies++;
                            if (!anomalyRows.includes(idx)) anomalyRows.push(idx);
                        }
                    }
                });
            });

            if (totalAnomalies > 0) {
                respond('‚ö†Ô∏è <strong>' + totalAnomalies + t('anomaliesFound') + '</strong>' + t('inLines') + anomalyRows.length + t('linesText') + t('anomalyExplanation'));
                showTable(anomalyRows);
            } else {
                respond(t('noAnomalies'));
                showTable();
            }
        }

        function showStats() {
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';

            let html = '';
            numericCols.forEach(col => {
                const values = csvData.map(r => r[col]).filter(v => typeof v === 'number');
                const mean = (values.reduce((a,b) => a+b, 0) / values.length).toFixed(2);
                const min = Math.min(...values).toFixed(2);
                const max = Math.max(...values).toFixed(2);

                html += `
                    <div class="stat-card">
                        <h3>${mean}</h3>
                        <p><strong>${col}</strong></p>
                        <small>Min: ${min} | Max: ${max}</small>
                    </div>
                `;
            });

            document.getElementById('statsGrid').innerHTML = html;
            respond(t('statsResponse'));
        }

        // Initialisation
        initTheme();
        applyTranslations();
    </script>
</body>
</html>
